name: Auto Version Increment

on:
  push:
    branches: [ main ]

# Garante que o GITHUB_TOKEN tenha permissão para commitar/push
permissions:
  contents: write

jobs:
  auto-version:
    # Evita loop quando o commit é feito pelo próprio bot
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Increment version
        shell: bash
        run: |
          set -euo pipefail

          # Se não existir, cria um arquivo version.txt inicial
          if [ ! -f version.txt ]; then
            echo "v0.0.0" > version.txt
          fi

          CURRENT_VERSION=$(cat version.txt)
          echo "Versão Atual: $CURRENT_VERSION"

          # Remove 'v' inicial se houver, incrementa o último número e re-adiciona 'v'
          STRIPPED=${CURRENT_VERSION#v}
          NEW_VERSION_NUM=$(echo "$STRIPPED" | awk -F. -v OFS=. '{$NF = $NF + 1; print}')
          NEW_VERSION="v${NEW_VERSION_NUM}"

          echo "Nova Versão: $NEW_VERSION"
          echo "$NEW_VERSION" > version.txt
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Commit and push new version
        shell: bash
        run: |
          # Só commita e faz push se houver mudanças staged
          git add version.txt

          if ! git diff --cached --quiet; then
            git commit -m "ci: Increment version to ${{ env.NEW_VERSION }}"
            git push origin main
          else
            echo "No changes to commit"
          fi